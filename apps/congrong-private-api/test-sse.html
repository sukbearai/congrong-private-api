<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI MedSci Chat SSE 测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        textarea, input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .response {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .error {
            color: red;
            background-color: #ffe6e6;
        }
        .success {
            color: green;
            background-color: #e6ffe6;
        }
    </style>
</head>
<body>
    <h1>AI MedSci Chat SSE 测试</h1>

    <div class="form-group">
        <label for="query">问题:</label>
        <textarea id="query" rows="3" placeholder="请输入您的问题...">中药方组成</textarea>
    </div>

    <div class="form-group">
        <label for="response_mode">响应模式:</label>
        <select id="response_mode">
            <option value="streaming">Streaming (流式)</option>
            <option value="blocking">Blocking (阻塞)</option>
        </select>
    </div>

    <div class="form-group">
        <label for="user">用户:</label>
        <input type="text" id="user" value="测试用户">
    </div>

    <button id="sendBtn" onclick="sendRequest()">发送请求</button>
    <button id="clearBtn" onclick="clearResponse()">清空响应</button>

    <div id="response" class="response" style="display: none;"></div>

    <script>
        let eventSource = null;
        let controller = null;

        async function sendRequest() {
            const responseDiv = document.getElementById('response');
            const sendBtn = document.getElementById('sendBtn');
            const clearBtn = document.getElementById('clearBtn');

            // 获取表单数据
            const query = document.getElementById('query').value;
            const response_mode = document.getElementById('response_mode').value;
            const user = document.getElementById('user').value;

            if (!query.trim()) {
                alert('请输入问题');
                return;
            }

            // 禁用发送按钮
            sendBtn.disabled = true;
            clearBtn.disabled = false;

            // 清空并显示响应区域
            responseDiv.style.display = 'block';
            responseDiv.className = 'response';
            responseDiv.innerHTML = '正在发送请求...\n';

            const data = {
                inputs: {},
                query: query.trim(),
                response_mode: response_mode,
                conversation_id: '',
                user: user.trim(),
                files: []
            };

            if (response_mode === 'streaming') {
                // 使用 Fetch 处理 SSE
                try {
                    controller = new AbortController();
                    const response = await fetch('/api/thirdparty/ai-medsci-chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'text/event-stream',
                        },
                        body: JSON.stringify(data),
                        signal: controller.signal
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();

                    responseDiv.innerHTML = '开始接收流式数据...\n\n';

                    while (true) {
                        const { done, value } = await reader.read();

                        if (done) {
                            responseDiv.innerHTML += '\n\n=== 数据传输完成 ===';
                            break;
                        }

                        const chunk = decoder.decode(value, { stream: true });
                        responseDiv.innerHTML += chunk;
                        responseDiv.scrollTop = responseDiv.scrollHeight;
                    }

                } catch (error) {
                    responseDiv.className = 'response error';
                    responseDiv.innerHTML = `错误: ${error.message}`;
                } finally {
                    sendBtn.disabled = false;
                    clearBtn.disabled = true;
                    controller = null;
                }
            } else {
                // Blocking 模式
                try {
                    const response = await fetch('/api/thirdparty/ai-medsci-chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();
                    responseDiv.className = 'response success';
                    responseDiv.innerHTML = JSON.stringify(result, null, 2);

                } catch (error) {
                    responseDiv.className = 'response error';
                    responseDiv.innerHTML = `错误: ${error.message}`;
                } finally {
                    sendBtn.disabled = false;
                    clearBtn.disabled = true;
                }
            }
        }

        function clearResponse() {
            const responseDiv = document.getElementById('response');

            if (controller) {
                controller.abort();
                controller = null;
            }

            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }

            responseDiv.style.display = 'none';
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('clearBtn').disabled = true;
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('clearBtn').disabled = true;
        });
    </script>
</body>
</html>